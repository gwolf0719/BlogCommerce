<template>
  <div class="admin-page">
    <!-- 1. È†ÅÈù¢Ê®ôÈ°åÂçÄ -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <h1 class="page-title">Âª£ÂëäÁÆ°ÁêÜ</h1>
          <p class="page-description">ÁÆ°ÁêÜÁ∂≤Á´ôËº™Êí≠Âª£ÂëäÂíåÊé®Âª£Ê©´ÂπÖ</p>
        </div>
        <div class="action-section">
          <a-button type="primary" @click="showCreateModal">
            <template #icon><PlusOutlined /></template>
            Êñ∞Â¢ûÂª£Âëä
          </a-button>
        </div>
      </div>
    </div>

    <!-- 2. Áµ±Ë®àÂç°ÁâáÂçÄ -->
    <div class="stats-section">
      <a-row :gutter="24" class="stats-row">
        <a-col :span="6">
          <a-card>
            <a-statistic
              title="Á∏ΩÂª£ÂëäÊï∏"
              :value="banners.length"
              prefix="üéØ"
              :value-style="{ color: '#1890ff' }"
            />
          </a-card>
        </a-col>
        <a-col :span="6">
          <a-card>
            <a-statistic
              title="ÂïüÁî®Âª£Âëä"
              :value="activeCount"
              prefix="‚úÖ"
              :value-style="{ color: '#52c41a' }"
            />
          </a-card>
        </a-col>
        <a-col :span="6">
          <a-card>
            <a-statistic
              title="Á∏ΩÈªûÊìäÊï∏"
              :value="totalClicks"
              prefix="üëÜ"
              :value-style="{ color: '#faad14' }"
            />
          </a-card>
        </a-col>
        <a-col :span="6">
          <a-card>
            <a-statistic
              title="ÈªûÊìäÁéá"
              :value="clickRate"
              suffix="%"
              prefix="üìä"
              :precision="2"
              :value-style="{ color: '#722ed1' }"
            />
          </a-card>
        </a-col>
      </a-row>
    </div>

    <!-- 3. ÊêúÂ∞ãÁØ©ÈÅ∏ÂçÄ -->
    <div class="search-section">
      <a-card>
        <a-row :gutter="24">
          <a-col :span="6">
            <a-input
              v-model:value="searchForm.search"
              placeholder="ÊêúÂ∞ãÂª£ÂëäÊ®ôÈ°å"
              allow-clear
              @change="handleSearch"
            >
              <template #prefix>
                <search-outlined />
              </template>
            </a-input>
          </a-col>
          <a-col :span="4">
            <a-select
              v-model:value="searchForm.position"
              placeholder="ÈÅ∏Êìá‰ΩçÁΩÆ"
              allow-clear
              @change="handleSearch"
            >
              <a-select-option value="HOME">È¶ñÈ†Å</a-select-option>
              <a-select-option value="BLOG_LIST">ÊñáÁ´†ÂàóË°®</a-select-option>
              <a-select-option value="PRODUCT_LIST">ÂïÜÂìÅÂàóË°®</a-select-option>
            </a-select>
          </a-col>
          <a-col :span="4">
            <a-select
              v-model:value="searchForm.is_active"
              placeholder="ÈÅ∏ÊìáÁãÄÊÖã"
              allow-clear
              @change="handleSearch"
            >
              <a-select-option :value="true">ÂïüÁî®</a-select-option>
              <a-select-option :value="false">ÂÅúÁî®</a-select-option>
            </a-select>
          </a-col>
          <a-col :span="6">
            <a-range-picker
              v-model:value="searchForm.dateRange"
              :placeholder="['ÈñãÂßãÊôÇÈñì', 'ÁµêÊùüÊôÇÈñì']"
              @change="handleSearch"
            />
          </a-col>
          <a-col :span="4">
            <a-space>
              <a-button @click="handleSearch">
                <template #icon><SearchOutlined /></template>
                ÊêúÂ∞ã
              </a-button>
              <a-button @click="resetSearch">
                ÈáçÁΩÆ
              </a-button>
            </a-space>
          </a-col>
        </a-row>
      </a-card>
    </div>

    <!-- 4. Ë°®Ê†ºÂçÄ -->
    <div class="table-section">
      <a-card>
        <a-table
          :columns="columns"
          :data-source="banners"
          :loading="loading"
          :pagination="paginationConfig"
          :row-key="record => record.id"
          @change="handleTableChange"
        >
          <!-- Âª£ÂëäÂúñÁâá -->
          <template #bodyCell="{ column, record }">
            <template v-if="column.key === 'image'">
              <div class="banner-image">
                <div v-if="record.desktop_image || record.mobile_image" class="image-preview">
                  <img
                    v-if="record.desktop_image"
                    :src="getImageUrl(record.desktop_image)"
                    :alt="record.title"
                    class="banner-thumbnail desktop-img"
                    title="Ê°åÈù¢Áâà"
                  />
                  <img
                    v-if="record.mobile_image"
                    :src="getImageUrl(record.mobile_image)"
                    :alt="record.title"
                    class="banner-thumbnail mobile-img"
                    title="ÊâãÊ©üÁâà"
                  />
                </div>
                <div v-else class="no-image">
                  <picture-outlined />
                  <div class="no-image-text">Êú™Ë®≠ÂÆöÂúñÁâá</div>
                </div>
              </div>
            </template>

            <!-- Âª£Âëä‰ø°ÊÅØ -->
            <template v-else-if="column.key === 'title'">
              <div class="banner-info">
                <div class="banner-title">{{ record.title }}</div>
                <div class="banner-meta">
                  <span class="position-tag">
                    <a-tag :color="getPositionColor(record.position)">
                      {{ getPositionText(record.position) }}
                    </a-tag>
                  </span>
                  <span class="date-range">
                    {{ formatDate(record.start_date) }} - {{ formatDate(record.end_date) }}
                  </span>
                </div>
              </div>
            </template>

            <!-- ÈªûÊìäÊï∏ -->
            <template v-else-if="column.key === 'clicks'">
              <div class="click-stats">
                <div class="click-count">{{ record.click_count || 0 }}</div>
                <div class="view-count">ÁÄèË¶Ω: {{ record.view_count || 0 }}</div>
              </div>
            </template>

            <!-- ÁãÄÊÖã -->
            <template v-else-if="column.key === 'status'">
              <div class="status-cell">
                <a-switch
                  v-model:checked="record.is_active"
                  :loading="record.updating"
                  @change="toggleStatus(record)"
                />
                <a-tag v-if="!isValidPeriod(record)" color="orange">
                  Â∑≤ÈÅéÊúü
                </a-tag>
              </div>
            </template>

            <!-- Êìç‰Ωú -->
            <template v-else-if="column.key === 'actions'">
              <a-space>
                <a-button
                  type="primary"
                  size="small"
                  @click="editBanner(record)"
                >
                  <template #icon><EditOutlined /></template>
                  Á∑®ËºØ
                </a-button>
                <a-popconfirm
                  title="Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÂª£ÂëäÂóéÔºü"
                  @confirm="deleteBanner(record.id)"
                >
                  <a-button
                    type="primary"
                    danger
                    size="small"
                  >
                    <template #icon><DeleteOutlined /></template>
                    Âà™Èô§
                  </a-button>
                </a-popconfirm>
              </a-space>
            </template>
          </template>
        </a-table>
      </a-card>
    </div>

    <!-- 5. Êñ∞Â¢û/Á∑®ËºØÂΩàÁ™ó -->
    <a-modal
      v-model:open="modalVisible"
      :title="isEditing ? 'Á∑®ËºØÂª£Âëä' : 'Êñ∞Â¢ûÂª£Âëä'"
      :width="800"
      :confirm-loading="submitting"
      @ok="handleSubmit"
      @cancel="handleCancel"
    >
      <a-form
        ref="formRef"
        :model="form"
        :rules="rules"
        layout="vertical"
        @finish="handleSubmit"
      >
        <a-row :gutter="16">
          <a-col :span="12">
            <a-form-item label="Âª£ÂëäÊ®ôÈ°å" name="title">
              <a-input
                v-model:value="form.title"
                placeholder="Ë´ãËº∏ÂÖ•Âª£ÂëäÊ®ôÈ°å"
                :maxlength="100"
                show-count
              />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="È°ØÁ§∫‰ΩçÁΩÆ" name="position">
              <a-select v-model:value="form.position" placeholder="ÈÅ∏ÊìáÈ°ØÁ§∫‰ΩçÁΩÆ">
                <a-select-option value="HOME">È¶ñÈ†Å</a-select-option>
                <a-select-option value="BLOG_LIST">ÊñáÁ´†ÂàóË°®</a-select-option>
                <a-select-option value="PRODUCT_LIST">ÂïÜÂìÅÂàóË°®</a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
        </a-row>

        <a-form-item label="Âª£ÂëäÊèèËø∞" name="description">
          <a-textarea
            v-model:value="form.description"
            placeholder="Ë´ãËº∏ÂÖ•Âª£ÂëäÊèèËø∞"
            :rows="3"
            :maxlength="500"
            show-count
          />
        </a-form-item>

        <a-row :gutter="16">
          <a-col :span="12">
            <a-form-item label="ÈõªËÖ¶ÁâàÂúñÁâá" name="desktop_image">
              <upload-image 
                v-model="form.desktop_image" 
              />
              <div style="margin-top: 8px; font-size: 12px; color: #666;">
                Âª∫Ë≠∞Â∞∫ÂØ∏Ôºö1920√ó600px
              </div>
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="ÊâãÊ©üÁâàÂúñÁâá" name="mobile_image">
              <upload-image 
                v-model="form.mobile_image" 
              />
              <div style="margin-top: 8px; font-size: 12px; color: #666;">
                Âª∫Ë≠∞Â∞∫ÂØ∏Ôºö750√ó300px
              </div>
            </a-form-item>
          </a-col>
        </a-row>

        <a-form-item label="ÈÄ£ÁµêÁ∂≤ÂùÄ" name="link_url">
          <a-input
            v-model:value="form.link_url"
            placeholder="Ë´ãËº∏ÂÖ•ÈÄ£ÁµêÁ∂≤ÂùÄ (ÂèØÈÅ∏)"
            type="url"
          />
        </a-form-item>

        <a-row :gutter="16">
          <a-col :span="12">
            <a-form-item label="ÈñãÂßãÊôÇÈñì" name="start_date">
              <a-date-picker
                v-model:value="form.start_date"
                style="width: 100%"
                placeholder="ÈÅ∏ÊìáÈñãÂßãÊôÇÈñì"
                show-time
                format="YYYY-MM-DD HH:mm:ss"
              />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="ÁµêÊùüÊôÇÈñì" name="end_date">
              <a-date-picker
                v-model:value="form.end_date"
                style="width: 100%"
                placeholder="ÈÅ∏ÊìáÁµêÊùüÊôÇÈñì"
                show-time
                format="YYYY-MM-DD HH:mm:ss"
              />
            </a-form-item>
          </a-col>
        </a-row>

        <a-row :gutter="16">
          <a-col :span="12">
            <a-form-item label="ÊéíÂ∫èÈ†ÜÂ∫è" name="sort_order">
              <a-input-number
                v-model:value="form.sort_order"
                :min="0"
                :max="9999"
                placeholder="ÊéíÂ∫èÈ†ÜÂ∫è"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="ÁãÄÊÖã" name="is_active">
              <a-switch
                v-model:checked="form.is_active"
                checked-children="ÂïüÁî®"
                un-checked-children="ÂÅúÁî®"
              />
            </a-form-item>
          </a-col>
        </a-row>
      </a-form>
    </a-modal>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, computed, nextTick, watch } from 'vue'
import { message } from 'ant-design-vue'
import { 
  PlusOutlined, 
  SearchOutlined, 
  EditOutlined, 
  DeleteOutlined,
  PictureOutlined,
  ReloadOutlined
} from '@ant-design/icons-vue'
import { useAuthStore } from '../stores/auth'
import UploadImage from '../components/UploadImage.vue'
import dayjs from 'dayjs'

const authStore = useAuthStore()
const loading = ref(false)
const modalVisible = ref(false)
const submitting = ref(false)
const isEditing = ref(false)
const formRef = ref()

// Êï∏Êìö
const banners = ref([])
const stats = ref({
  totalClicks: 0,
  totalViews: 0,
  clickRate: 0
})

// ÊêúÂ∞ãË°®ÂñÆ
const searchForm = reactive({
  search: '',
  position: undefined,
  is_active: undefined,
  dateRange: []
})

// Ë°®ÂñÆ
const form = reactive({
  id: null,
  title: '',
  description: '',
  mobile_image: '',
  desktop_image: '',
  link_url: '',
  position: 'HOME',
  start_date: null,
  end_date: null,
  sort_order: 0,
  is_active: true
})

// ÂàÜÈ†Å
const pagination = reactive({
  current: 1,
  pageSize: 10,
  total: 0,
  showSizeChanger: true,
  showQuickJumper: true,
  showTotal: (total, range) => `Á¨¨ ${range[0]}-${range[1]} È†ÖÔºåÂÖ± ${total} È†Ö`
})

// Ë®àÁÆóÂ±¨ÊÄß
const activeCount = computed(() => 
  banners.value.filter(banner => banner.is_active).length
)

const totalClicks = computed(() => 
  banners.value.reduce((sum, banner) => sum + (banner.click_count || 0), 0)
)

const clickRate = computed(() => {
  const totalViews = banners.value.reduce((sum, banner) => sum + (banner.view_count || 0), 0)
  return totalViews > 0 ? (totalClicks.value / totalViews) * 100 : 0
})

const paginationConfig = computed(() => ({
  current: pagination.current,
  pageSize: pagination.pageSize,
  total: pagination.total,
  showSizeChanger: pagination.showSizeChanger,
  showQuickJumper: pagination.showQuickJumper,
  showTotal: pagination.showTotal
}))

// Ë°®Ê†ºÂàóÂÆöÁæ©
const columns = [
  {
    title: 'Âª£ÂëäÂúñÁâá',
    key: 'image',
    width: 80
  },
  {
    title: 'Âª£Âëä‰ø°ÊÅØ',
    key: 'title',
    width: 250
  },
  {
    title: 'ÈªûÊìäÁµ±Ë®à',
    key: 'clicks',
    width: 120,
    sorter: true
  },
  {
    title: 'ÁãÄÊÖã',
    key: 'status',
    width: 120,
    filters: [
      { text: 'ÂïüÁî®', value: true },
      { text: 'ÂÅúÁî®', value: false }
    ]
  },
  {
    title: 'Êìç‰Ωú',
    key: 'actions',
    width: 150,
    fixed: 'right'
  }
]

// Ë°®ÂñÆÈ©óË≠âË¶èÂâá
const rules = {
  title: [
    { required: true, message: 'Ë´ãËº∏ÂÖ•Âª£ÂëäÊ®ôÈ°å' },
    { min: 2, max: 100, message: 'Ê®ôÈ°åÈï∑Â∫¶ÊáâÂú®2-100Â≠óÁ¨¶‰πãÈñì' }
  ],
  position: [
    { required: true, message: 'Ë´ãÈÅ∏ÊìáÈ°ØÁ§∫‰ΩçÁΩÆ' }
  ],
  mobile_image: [
    { required: true, message: 'Ë´ã‰∏äÂÇ≥ÊâãÊ©üÁâàÂúñÁâá' }
  ],
  desktop_image: [
    { required: true, message: 'Ë´ã‰∏äÂÇ≥ÈõªËÖ¶ÁâàÂúñÁâá' }
  ],
  start_date: [
    { required: true, message: 'Ë´ãÈÅ∏ÊìáÈñãÂßãÊôÇÈñì' }
  ],
  end_date: [
    { required: true, message: 'Ë´ãÈÅ∏ÊìáÁµêÊùüÊôÇÈñì' }
  ]
}

// ËºâÂÖ•Âª£ÂëäÂàóË°®
const loadBanners = async () => {
  loading.value = true
  try {
    const params = new URLSearchParams()
    
    if (searchForm.search) {
      params.append('search', searchForm.search)
    }
    if (searchForm.position) {
      params.append('position', searchForm.position)
    }
    if (searchForm.is_active !== undefined) {
      params.append('is_active', searchForm.is_active)
    }
    if (searchForm.dateRange && searchForm.dateRange.length === 2) {
      params.append('start_date', searchForm.dateRange[0].format('YYYY-MM-DD'))
      params.append('end_date', searchForm.dateRange[1].format('YYYY-MM-DD'))
    }

    params.append('page', pagination.current)
    params.append('size', pagination.pageSize)

    const response = await fetch(`/api/banners?${params}`, {
      headers: {
        'Authorization': `Bearer ${authStore.token}`
      }
    })

    if (!response.ok) {
      // ÂòóË©¶Ëß£ÊûêAPIÈåØË™§ÈüøÊáâ
      let errorMessage = 'ËºâÂÖ•Âª£ÂëäÂ§±Êïó'
      
      try {
        const errorData = await response.json()
        
        // ËôïÁêÜ FastAPI È©óË≠âÈåØË™§Ê†ºÂºè
        if (errorData.detail && Array.isArray(errorData.detail)) {
          const errors = errorData.detail.map(err => err.msg || err.message || 'Êú™Áü•ÈåØË™§')
          errorMessage = errors.join(', ')
        } else if (errorData.detail && typeof errorData.detail === 'string') {
          errorMessage = errorData.detail
        } else if (errorData.message) {
          errorMessage = errorData.message
        } else if (errorData.msg) {
          errorMessage = errorData.msg
        }
      } catch (parseError) {
        console.error('Ëß£ÊûêÈåØË™§ÈüøÊáâÂ§±Êïó:', parseError)
      }
      
      throw new Error(errorMessage)
    }

    const data = await response.json()
    banners.value = data.items || data
    pagination.total = data.total || data.length

  } catch (error) {
    console.error('ËºâÂÖ•Âª£ÂëäÂ§±Êïó:', error)
    message.error(error.message)
  } finally {
    loading.value = false
  }
}

// ÊêúÂ∞ãËôïÁêÜ
const handleSearch = () => {
  pagination.current = 1
  loadBanners()
}

// ÈáçÁΩÆÊêúÂ∞ã
const resetSearch = () => {
  searchForm.search = ''
  searchForm.position = undefined
  searchForm.is_active = undefined
  searchForm.dateRange = []
  handleSearch()
}

// Ë°®Ê†ºËÆäÊõ¥ËôïÁêÜ
const handleTableChange = (paginationInfo, filters, sorter) => {
  pagination.current = paginationInfo.current
  pagination.pageSize = paginationInfo.pageSize
  loadBanners()
}

// È°ØÁ§∫Êñ∞Â¢ûÂΩàÁ™ó
const showCreateModal = () => {
  resetForm()
  isEditing.value = false
  modalVisible.value = true
}

// Á∑®ËºØÂª£Âëä
const editBanner = (record) => {
  resetForm()
  isEditing.value = true
  form.id = record.id
  form.title = record.title
  form.description = record.description || ''
  form.mobile_image = record.mobile_image || ''
  form.desktop_image = record.desktop_image || ''
  form.link_url = record.link_url || ''
  form.position = record.position
  form.start_date = record.start_date ? dayjs(record.start_date) : null
  form.end_date = record.end_date ? dayjs(record.end_date) : null
  form.sort_order = record.sort_order || 0
  form.is_active = record.is_active
  modalVisible.value = true
}

// ÈáçÁΩÆË°®ÂñÆ
const resetForm = () => {
  form.id = null
  form.title = ''
  form.description = ''
  form.mobile_image = ''
  form.desktop_image = ''
  form.link_url = ''
  form.position = 'HOME'
  form.start_date = null
  form.end_date = null
  form.sort_order = 0
  form.is_active = true
}

// Áõ£ËÅΩÂúñÁâáÂ≠óÊÆµËÆäÂåñÔºåËá™ÂãïËôïÁêÜÈ©óË≠â
watch(() => form.desktop_image, (newValue) => {
  if (newValue) {
    // ÊúâÂúñÁâáÊôÇÊ∏ÖÈô§È©óË≠âÈåØË™§
    formRef.value?.clearValidate('desktop_image')
  }
})

watch(() => form.mobile_image, (newValue) => {
  if (newValue) {
    // ÊúâÂúñÁâáÊôÇÊ∏ÖÈô§È©óË≠âÈåØË™§
    formRef.value?.clearValidate('mobile_image')
  }
})

// Êèê‰∫§Ë°®ÂñÆ
const handleSubmit = async () => {
  try {
    await formRef.value.validate()
    
    submitting.value = true
    
    const submitData = {
      title: form.title,
      description: form.description,
      mobile_image: form.mobile_image,
      desktop_image: form.desktop_image,
      link_url: form.link_url,
      position: form.position,
      start_date: form.start_date ? form.start_date.format('YYYY-MM-DD HH:mm:ss') : null,
      end_date: form.end_date ? form.end_date.format('YYYY-MM-DD HH:mm:ss') : null,
      sort_order: form.sort_order,
      is_active: form.is_active
    }

    const url = isEditing.value ? `/api/banners/${form.id}` : '/api/banners'
    const method = isEditing.value ? 'PUT' : 'POST'

    const response = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authStore.token}`
      },
      body: JSON.stringify(submitData)
    })

    if (!response.ok) {
      // ÂòóË©¶Ëß£ÊûêAPIÈåØË™§ÈüøÊáâ
      let errorMessage = isEditing.value ? 'Êõ¥Êñ∞Âª£ÂëäÂ§±Êïó' : 'Êñ∞Â¢ûÂª£ÂëäÂ§±Êïó'
      
      try {
        const errorData = await response.json()
        
        // ËôïÁêÜ FastAPI È©óË≠âÈåØË™§Ê†ºÂºè
        if (errorData.detail && Array.isArray(errorData.detail)) {
          const errors = errorData.detail.map(err => err.msg || err.message || 'Êú™Áü•ÈåØË™§')
          errorMessage = errors.join(', ')
        } else if (errorData.detail && typeof errorData.detail === 'string') {
          errorMessage = errorData.detail
        } else if (errorData.message) {
          errorMessage = errorData.message
        } else if (errorData.msg) {
          errorMessage = errorData.msg
        }
      } catch (parseError) {
        console.error('Ëß£ÊûêÈåØË™§ÈüøÊáâÂ§±Êïó:', parseError)
      }
      
      throw new Error(errorMessage)
    }

    message.success(isEditing.value ? 'Âª£ÂëäÂ∑≤Êõ¥Êñ∞' : 'Âª£ÂëäÂ∑≤Êñ∞Â¢û')
    modalVisible.value = false
    loadBanners()

  } catch (error) {
    console.error('Êèê‰∫§Â§±Êïó:', error)
    message.error(error.message)
  } finally {
    submitting.value = false
  }
}

// ÂèñÊ∂àÁ∑®ËºØ
const handleCancel = () => {
  modalVisible.value = false
  resetForm()
}

// ÂàáÊèõÁãÄÊÖã
const toggleStatus = async (record) => {
  record.updating = true
  try {
    const response = await fetch(`/api/banners/${record.id}/toggle`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authStore.token}`
      }
    })

    if (!response.ok) {
      // ÂòóË©¶Ëß£ÊûêAPIÈåØË™§ÈüøÊáâ
      let errorMessage = 'ÁãÄÊÖãÂàáÊèõÂ§±Êïó'
      
      try {
        const errorData = await response.json()
        
        // ËôïÁêÜ FastAPI È©óË≠âÈåØË™§Ê†ºÂºè
        if (errorData.detail && Array.isArray(errorData.detail)) {
          const errors = errorData.detail.map(err => err.msg || err.message || 'Êú™Áü•ÈåØË™§')
          errorMessage = errors.join(', ')
        } else if (errorData.detail && typeof errorData.detail === 'string') {
          errorMessage = errorData.detail
        } else if (errorData.message) {
          errorMessage = errorData.message
        } else if (errorData.msg) {
          errorMessage = errorData.msg
        }
      } catch (parseError) {
        console.error('Ëß£ÊûêÈåØË™§ÈüøÊáâÂ§±Êïó:', parseError)
      }
      
      throw new Error(errorMessage)
    }

    message.success('ÁãÄÊÖãÂ∑≤Êõ¥Êñ∞')
    loadBanners()

  } catch (error) {
    console.error('ÁãÄÊÖãÂàáÊèõÂ§±Êïó:', error)
    message.error(error.message)
    // ÊÅ¢Âæ©ÂéüÁãÄÊÖã
    record.is_active = !record.is_active
  } finally {
    record.updating = false
  }
}

// Âà™Èô§Âª£Âëä
const deleteBanner = async (id) => {
  try {
    const response = await fetch(`/api/banners/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${authStore.token}`
      }
    })

    if (!response.ok) {
      // ÂòóË©¶Ëß£ÊûêAPIÈåØË™§ÈüøÊáâ
      let errorMessage = 'Âà™Èô§Âª£ÂëäÂ§±Êïó'
      
      try {
        const errorData = await response.json()
        
        // ËôïÁêÜ FastAPI È©óË≠âÈåØË™§Ê†ºÂºè
        if (errorData.detail && Array.isArray(errorData.detail)) {
          const errors = errorData.detail.map(err => err.msg || err.message || 'Êú™Áü•ÈåØË™§')
          errorMessage = errors.join(', ')
        } else if (errorData.detail && typeof errorData.detail === 'string') {
          errorMessage = errorData.detail
        } else if (errorData.message) {
          errorMessage = errorData.message
        } else if (errorData.msg) {
          errorMessage = errorData.msg
        }
      } catch (parseError) {
        console.error('Ëß£ÊûêÈåØË™§ÈüøÊáâÂ§±Êïó:', parseError)
      }
      
      throw new Error(errorMessage)
    }

    message.success('Âª£ÂëäÂ∑≤Âà™Èô§')
    loadBanners()

  } catch (error) {
    console.error('Âà™Èô§Âª£ÂëäÂ§±Êïó:', error)
    message.error(error.message)
  }
}

// Â∑•ÂÖ∑ÂáΩÊï∏
const getImageUrl = (imagePath) => {
  if (!imagePath) return ''
  
  // Â¶ÇÊûúÂ∑≤Á∂ìÊòØÂÆåÊï¥ÁöÑ URLÔºåÁõ¥Êé•ËøîÂõû
  if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
    return imagePath
  }
  
  // Â¶ÇÊûúÊòØÁõ∏Â∞çË∑ØÂæëÔºåÂä†‰∏ä baseURL
  const baseURL = 'http://localhost:8002'
  return `${baseURL}${imagePath}`
}

const getPositionColor = (position) => {
  const colors = {
    'HOME': 'blue',
    'BLOG_LIST': 'green',
    'PRODUCT_LIST': 'orange'
  }
  return colors[position] || 'default'
}

const getPositionText = (position) => {
  const texts = {
    'HOME': 'È¶ñÈ†Å',
    'BLOG_LIST': 'ÊñáÁ´†ÂàóË°®',
    'PRODUCT_LIST': 'ÂïÜÂìÅÂàóË°®'
  }
  return texts[position] || position
}

const formatDate = (date) => {
  return date ? dayjs(date).format('YYYY-MM-DD HH:mm') : '-'
}

const isValidPeriod = (record) => {
  const now = dayjs()
  const start = dayjs(record.start_date)
  const end = dayjs(record.end_date)
  return now.isAfter(start) && now.isBefore(end)
}

// ÁîüÂëΩÈÄ±Êúü
onMounted(() => {
  loadBanners()
})
</script>

<style scoped>
.admin-page {
  padding: 0;
}

.page-header {
  margin-bottom: 24px;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}

.title-section h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 600;
}

.title-section p {
  margin: 4px 0 0 0;
  color: #666;
}

.stats-section {
  margin-bottom: 24px;
}

.search-section {
  margin-bottom: 24px;
}

.table-section {
  margin-bottom: 24px;
}

.banner-image {
  width: 80px;
  height: 50px;
  border-radius: 4px;
  overflow: hidden;
  background: #f5f5f5;
  display: flex;
  align-items: center;
  justify-content: center;
}

.image-preview {
  display: flex;
  gap: 2px;
  width: 100%;
  height: 100%;
}

.banner-thumbnail {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 2px;
}

.desktop-img {
  border: 1px solid #1890ff;
}

.mobile-img {
  border: 1px solid #52c41a;
}

.no-image {
  color: #ccc;
  font-size: 18px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.no-image-text {
  font-size: 10px;
  margin-top: 2px;
}

.banner-info {
  padding: 4px 0;
}

.banner-title {
  font-weight: 500;
  margin-bottom: 4px;
}

.banner-meta {
  display: flex;
  align-items: center;
  gap: 8px;
}

.date-range {
  color: #666;
  font-size: 12px;
}

.click-stats {
  text-align: center;
}

.click-count {
  font-size: 16px;
  font-weight: 500;
  color: #1890ff;
}

.view-count {
  font-size: 12px;
  color: #666;
}

.status-cell {
  display: flex;
  align-items: center;
  gap: 8px;
}
</style> 