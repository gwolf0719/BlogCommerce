<!--
è¡ŒéŠ·å°ˆæ¡ˆç®¡ç†ä»‹é¢

æ­¤çµ„ä»¶æä¾›å®Œæ•´çš„è¡ŒéŠ·å°ˆæ¡ˆç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬å°ˆæ¡ˆçš„å‰µå»ºã€ç·¨è¼¯ã€åˆªé™¤ã€ç‹€æ…‹ç®¡ç†ï¼Œ
ä»¥åŠå„ªæƒ åˆ¸çš„ç”Ÿæˆã€åˆ†ç™¼å’Œçµ±è¨ˆæŸ¥çœ‹ç­‰åŠŸèƒ½ã€‚

ä¸»è¦åŠŸèƒ½æ¨¡çµ„ï¼š
1. å°ˆæ¡ˆåˆ—è¡¨å±•ç¤ºï¼šæ”¯æ´åˆ†é ã€æœå°‹ã€ç¯©é¸
2. å°ˆæ¡ˆ CRUD æ“ä½œï¼šå‰µå»ºã€ç·¨è¼¯ã€åˆªé™¤å°ˆæ¡ˆ
3. å„ªæƒ åˆ¸ç®¡ç†ï¼šæ‰¹æ¬¡ç”Ÿæˆã€åˆ†ç™¼çµ¦ç”¨æˆ¶
4. çµ±è¨ˆè³‡æ–™ï¼šå°ˆæ¡ˆç¸½è¦½ã€è©³ç´°çµ±è¨ˆã€ä½¿ç”¨æƒ…æ³åˆ†æ
5. ç‹€æ…‹ç®¡ç†ï¼šå°ˆæ¡ˆç‹€æ…‹åˆ‡æ›ï¼ˆè‰ç¨¿/é€²è¡Œä¸­/æš«åœ/å®Œæˆ/å–æ¶ˆï¼‰

ç•Œé¢çµ„ä»¶ï¼š
- å°ˆæ¡ˆçµ±è¨ˆå¡ç‰‡ï¼šé¡¯ç¤ºç¸½æ•¸ã€é€²è¡Œä¸­å°ˆæ¡ˆã€ç”Ÿæˆå„ªæƒ åˆ¸æ•¸ç­‰
- æœå°‹ç¯©é¸å€ï¼šæ”¯æ´åç¨±æœå°‹ã€ç‹€æ…‹ç¯©é¸
- å°ˆæ¡ˆè³‡æ–™è¡¨æ ¼ï¼šå±•ç¤ºå°ˆæ¡ˆè©³ç´°è³‡è¨Šå’Œæ“ä½œæŒ‰éˆ•
- å°ˆæ¡ˆç·¨è¼¯ Modalï¼šå°ˆæ¡ˆå‰µå»ºå’Œç·¨è¼¯è¡¨å–®
- å„ªæƒ åˆ¸ç®¡ç† Modalï¼šç”Ÿæˆã€åˆ†ç™¼ã€çµ±è¨ˆç­‰åŠŸèƒ½

æ¬Šé™è¦æ±‚ï¼š
- åƒ…ç®¡ç†å“¡å¯è¨ªå•æ­¤é é¢
- æ‰€æœ‰æ“ä½œéƒ½éœ€è¦ JWT èº«ä»½é©—è­‰

ä½œè€…ï¼šAI Assistant
å‰µå»ºæ—¥æœŸï¼š2024
ç‰ˆæœ¬ï¼š1.0
-->

<template>
  <div class="admin-page">
    <!-- 1. é é¢æ¨™é¡Œå€ -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <h1 class="page-title">è¡ŒéŠ·å°ˆæ¡ˆç®¡ç†</h1>
          <p class="page-description">å‰µå»ºå’Œç®¡ç†ä¿ƒéŠ·æ´»å‹•èˆ‡å„ªæƒ åˆ¸ç™¼æ”¾å°ˆæ¡ˆ</p>
        </div>
        <div class="action-section">
          <a-space>
            <a-button type="primary" @click="showCreateModal">
              <template #icon><PlusOutlined /></template>
              å»ºç«‹å°ˆæ¡ˆ
            </a-button>
            <a-button @click="showStatsModal">
              <template #icon><BarChartOutlined /></template>
              çµ±è¨ˆç¸½è¦½
            </a-button>
          </a-space>
        </div>
      </div>
    </div>

    <!-- 2. çµ±è¨ˆå¡ç‰‡å€ -->
    <div class="stats-section">
      <a-row :gutter="24" class="stats-row">
        <a-col :span="6">
          <a-card>
            <a-statistic 
              title="ç¸½å°ˆæ¡ˆæ•¸" 
              :value="stats.total_campaigns" 
              :loading="statsLoading"
              prefix="ğŸ“Š"
              :value-style="{ color: '#1890ff' }"
            />
          </a-card>
        </a-col>
        <a-col :span="6">
          <a-card>
            <a-statistic 
              title="é€²è¡Œä¸­å°ˆæ¡ˆ" 
              :value="stats.active_campaigns" 
              :loading="statsLoading"
              prefix="âš¡"
              :value-style="{ color: '#52c41a' }"
            />
          </a-card>
        </a-col>
        <a-col :span="6">
          <a-card>
            <a-statistic 
              title="ç”Ÿæˆå„ªæƒ åˆ¸" 
              :value="stats.total_coupons_generated" 
              :loading="statsLoading"
              prefix="ğŸ«"
              :value-style="{ color: '#fa8c16' }"
            />
          </a-card>
        </a-col>
        <a-col :span="6">
          <a-card>
            <a-statistic 
              title="ç¸½ç¯€çœé‡‘é¡" 
              :value="stats.total_discount_amount" 
              prefix="ğŸ’°$"
              :precision="2"
              :loading="statsLoading"
              :value-style="{ color: '#722ed1' }"
            />
          </a-card>
        </a-col>
      </a-row>
    </div>

    <!-- 3. æœå°‹ç¯©é¸å€ -->
    <div class="filter-section">
      <a-card class="filter-card">
        <a-row :gutter="24">
          <a-col :span="8">
            <a-input-search 
              v-model:value="searchText" 
              placeholder="æœå°‹å°ˆæ¡ˆåç¨±æˆ–æè¿°" 
              @search="loadCampaigns"
              allow-clear
            />
          </a-col>
          <a-col :span="4">
            <a-select v-model:value="filterStatus" placeholder="ç‹€æ…‹ç¯©é¸" allow-clear @change="loadCampaigns">
              <a-select-option value="draft">è‰ç¨¿</a-select-option>
              <a-select-option value="active">é€²è¡Œä¸­</a-select-option>
              <a-select-option value="completed">å·²å®Œæˆ</a-select-option>
              <a-select-option value="cancelled">å·²å–æ¶ˆ</a-select-option>
            </a-select>
          </a-col>
          <a-col :span="4">
            <a-button @click="resetFilters">é‡ç½®ç¯©é¸</a-button>
          </a-col>
          <a-col :span="4">
            <a-button type="primary" @click="loadCampaigns">æœå°‹</a-button>
          </a-col>
        </a-row>
      </a-card>
    </div>

    <!-- 4. ä¸»è¦å…§å®¹å€ -->
    <div class="content-section">
      <a-card class="content-card">
        <a-table
          :columns="columns"
          :data-source="campaigns"
          :loading="loading"
          :pagination="{
            current: pagination.current,
            pageSize: pagination.pageSize,
            total: pagination.total,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total) => `å…± ${total} ç­†è¨˜éŒ„`
          }"
          @change="handleTableChange"
          row-key="id"
          :scroll="{ x: 1200 }"
        >
          <template #bodyCell="{ column, record }">
            <template v-if="column.key === 'name'">
              <div class="title-cell">
                <div class="campaign-title">{{ record.name }}</div>
                <div class="campaign-prefix">{{ record.coupon_prefix }}</div>
              </div>
            </template>
            
            <template v-if="column.key === 'status'">
              <a-tag :color="getStatusColor(record.status)" size="default">
                <template #icon>
                  <span>{{ getStatusIcon(record.status) }}</span>
                </template>
                {{ getStatusText(record.status) }}
              </a-tag>
            </template>
            
            <template v-if="column.key === 'coupon_info'">
              <div class="coupon-info-cell">
                <div class="coupon-type">{{ getCouponTypeText(record.coupon_type) }}</div>
                <div class="coupon-discount">{{ formatDiscount(record.discount_type, record.discount_value) }}</div>
              </div>
            </template>
            
            <template v-if="column.key === 'period'">
              <div class="period-cell">
                <div class="period-campaign">{{ formatDate(record.campaign_start) }} - {{ formatDate(record.campaign_end) }}</div>
                <div class="period-coupon">åˆ¸æ•ˆæœŸï¼š{{ formatDate(record.coupon_valid_from) }} - {{ formatDate(record.coupon_valid_to) }}</div>
              </div>
            </template>
            
            <template v-if="column.key === 'progress'">
              <div class="progress-cell">
                <div class="progress-numbers">å·²ç”Ÿæˆï¼š{{ record.generated_count }} / {{ record.total_coupons }}</div>
                <a-progress 
                  :percent="(record.generated_count / record.total_coupons) * 100" 
                  :showInfo="false" 
                  size="small"
                />
                <div class="progress-stats">å·²åˆ†ç™¼ï¼š{{ record.distributed_count }} | å·²ä½¿ç”¨ï¼š{{ record.used_count }}</div>
              </div>
            </template>
            
            <template v-if="column.key === 'actions'">
              <a-space>
                <a-button type="primary" size="small" @click="editCampaign(record)">
                  <EditOutlined /> ç·¨è¼¯
                </a-button>
                <a-button size="small" @click="showCouponModal(record)">
                  <template #icon>ğŸ«</template>
                  å„ªæƒ åˆ¸
                </a-button>
                <a-button size="small" @click="showStatsModal(record)">
                  <BarChartOutlined /> çµ±è¨ˆ
                </a-button>
                <a-dropdown>
                  <template #overlay>
                    <a-menu>
                      <a-menu-item @click="showGenerateModal(record)">
                        <template #icon>ğŸ­</template>
                        ç”Ÿæˆå„ªæƒ åˆ¸
                      </a-menu-item>
                      <a-menu-item @click="showDistributeModal(record)">
                        <template #icon>ğŸ“¤</template>
                        åˆ†ç™¼å„ªæƒ åˆ¸
                      </a-menu-item>
                      <a-menu-divider />
                      <a-menu-item @click="updateStatus(record, 'active')" :disabled="record.status === 'active'">
                        <template #icon>â–¶ï¸</template>
                        å•Ÿå‹•å°ˆæ¡ˆ
                      </a-menu-item>
                      <a-menu-item @click="updateStatus(record, 'paused')" :disabled="record.status === 'paused'">
                        <template #icon>â¸ï¸</template>
                        æš«åœå°ˆæ¡ˆ
                      </a-menu-item>
                      <a-menu-item @click="updateStatus(record, 'completed')" :disabled="record.status === 'completed'">
                        <template #icon>âœ…</template>
                        å®Œæˆå°ˆæ¡ˆ
                      </a-menu-item>
                      <a-menu-divider />
                      <a-menu-item @click="deleteCampaign(record.id)" danger>
                        <DeleteOutlined /> åˆªé™¤å°ˆæ¡ˆ
                      </a-menu-item>
                    </a-menu>
                  </template>
                  <a-button size="small">
                    æ›´å¤š <DownOutlined />
                  </a-button>
                </a-dropdown>
              </a-space>
            </template>
          </template>
        </a-table>
      </a-card>
    </div>

    <!-- å‰µå»º/ç·¨è¼¯å°ˆæ¡ˆ Modal -->
    <a-modal
      v-model:open="createModalVisible"
      :title="editingCampaign ? 'ç·¨è¼¯å°ˆæ¡ˆ' : 'å‰µå»ºå°ˆæ¡ˆ'"
      width="1000px"
      @ok="handleCreateOrUpdate"
      @cancel="resetForm"
      class="campaign-modal"
    >
      <a-form
        ref="formRef"
        :model="campaignForm"
        :rules="formRules"
        layout="vertical"
      >
        <a-card title="åŸºæœ¬ä¿¡æ¯" size="small" class="form-card">
          <a-row :gutter="16">
            <a-col :span="12">
              <a-form-item label="å°ˆæ¡ˆåç¨±" name="name">
                <a-input v-model:value="campaignForm.name" placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨±" />
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="å„ªæƒ ç¢¼å‰ç¶´" name="coupon_prefix">
                <a-input v-model:value="campaignForm.coupon_prefix" placeholder="ä¾‹å¦‚ï¼šSALE2024" />
              </a-form-item>
            </a-col>
          </a-row>
          
          <a-form-item label="å°ˆæ¡ˆæè¿°" name="description">
            <a-textarea v-model:value="campaignForm.description" :rows="3" placeholder="è¼¸å…¥å°ˆæ¡ˆæè¿°" />
          </a-form-item>
        </a-card>

        <a-card title="å„ªæƒ åˆ¸è¨­å®š" size="small" class="form-card">
          <a-row :gutter="16">
            <a-col :span="8">
              <a-form-item label="å„ªæƒ åˆ¸é¡å‹" name="coupon_type">
                <a-select v-model:value="campaignForm.coupon_type">
                  <a-select-option value="product_discount">å•†å“æŠ˜æ‰£</a-select-option>
                  <a-select-option value="order_discount">æ•´ç­†æŠ˜æ‰£</a-select-option>
                  <a-select-option value="free_shipping">å…é‹è²»</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item label="æŠ˜æ‰£é¡å‹" name="discount_type">
                <a-select v-model:value="campaignForm.discount_type">
                  <a-select-option value="fixed">å›ºå®šé‡‘é¡</a-select-option>
                  <a-select-option value="percentage">ç™¾åˆ†æ¯”</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item label="æŠ˜æ‰£å€¼" name="discount_value">
                <a-input-number 
                  v-model:value="campaignForm.discount_value" 
                  :min="0"
                  :max="campaignForm.discount_type === 'percentage' ? 100 : undefined"
                  :precision="2"
                  style="width: 100%"
                  :addon-after="campaignForm.discount_type === 'percentage' ? '%' : '$'"
                />
              </a-form-item>
            </a-col>
          </a-row>
          
          <a-row :gutter="16">
            <a-col :span="8">
              <a-form-item label="æœ€ä½æ¶ˆè²»" name="minimum_amount">
                <a-input-number 
                  v-model:value="campaignForm.minimum_amount" 
                  :min="0"
                  :precision="2"
                  style="width: 100%"
                  addon-after="$"
                  placeholder="å¯é¸"
                />
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item label="æœ€é«˜æŠ˜æ‰£" name="maximum_discount">
                <a-input-number 
                  v-model:value="campaignForm.maximum_discount" 
                  :min="0"
                  :precision="2"
                  style="width: 100%"
                  addon-after="$"
                  placeholder="å¯é¸"
                />
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item label="ç¸½å„ªæƒ åˆ¸æ•¸" name="total_coupons">
                <a-input-number 
                  v-model:value="campaignForm.total_coupons" 
                  :min="1"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
          </a-row>
        </a-card>

        <a-card title="æ™‚é–“è¨­å®š" size="small" class="form-card">
          <a-row :gutter="16">
            <a-col :span="12">
              <a-form-item label="å°ˆæ¡ˆé–‹å§‹æ™‚é–“" name="campaign_start">
                <a-date-picker 
                  v-model:value="campaignForm.campaign_start" 
                  show-time 
                  format="YYYY-MM-DD HH:mm:ss"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="å°ˆæ¡ˆçµæŸæ™‚é–“" name="campaign_end">
                <a-date-picker 
                  v-model:value="campaignForm.campaign_end" 
                  show-time 
                  format="YYYY-MM-DD HH:mm:ss"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
          </a-row>
          
          <a-row :gutter="16">
            <a-col :span="12">
              <a-form-item label="å„ªæƒ åˆ¸æœ‰æ•ˆé–‹å§‹" name="coupon_valid_from">
                <a-date-picker 
                  v-model:value="campaignForm.coupon_valid_from" 
                  show-time 
                  format="YYYY-MM-DD HH:mm:ss"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="å„ªæƒ åˆ¸æœ‰æ•ˆçµæŸ" name="coupon_valid_to">
                <a-date-picker 
                  v-model:value="campaignForm.coupon_valid_to" 
                  show-time 
                  format="YYYY-MM-DD HH:mm:ss"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
          </a-row>
        </a-card>

        <a-card title="å°ˆæ¡ˆè¨­å®š" size="small" class="form-card">
          <a-row :gutter="16">
            <a-col :span="12">
              <a-form-item label="åˆå§‹ç”Ÿæˆæ•¸é‡" name="initial_coupons">
                <a-input-number 
                  v-model:value="campaignForm.initial_coupons" 
                  :min="0"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="å°ˆæ¡ˆç‹€æ…‹" name="status">
                <a-select v-model:value="campaignForm.status">
                  <a-select-option value="draft">è‰ç¨¿</a-select-option>
                  <a-select-option value="active">é€²è¡Œä¸­</a-select-option>
                  <a-select-option value="paused">æš«åœ</a-select-option>
                  <a-select-option value="completed">å·²å®Œæˆ</a-select-option>
                  <a-select-option value="cancelled">å·²å–æ¶ˆ</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
          </a-row>
        </a-card>
      </a-form>
    </a-modal>

    <!-- å…¶ä»– Modal çµ„ä»¶... -->
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { message } from 'ant-design-vue'
import { 
  PlusOutlined, 
  BarChartOutlined,
  DownOutlined,
  EditOutlined,
  DeleteOutlined
} from '@ant-design/icons-vue'
import { useAuthStore } from '@/stores/auth'
import dayjs from 'dayjs'

const authStore = useAuthStore()

// éŸ¿æ‡‰å¼æ•¸æ“š
const loading = ref(false)
const statsLoading = ref(false)
const createModalVisible = ref(false)
const editingCampaign = ref(null)

const campaigns = ref([])
const stats = ref({
  total_campaigns: 0,
  active_campaigns: 0,
  total_coupons_generated: 0,
  total_discount_amount: 0
})

// æœå°‹å’Œç¯©é¸
const searchText = ref('')
const filterStatus = ref(null)

// åˆ†é 
const pagination = reactive({
  current: 1,
  pageSize: 20,
  total: 0
})

// è¡¨å–®æ•¸æ“š
const campaignForm = reactive({
  name: '',
  description: '',
  coupon_prefix: '',
  coupon_type: 'order_discount',
  discount_type: 'fixed',
  discount_value: 0,
  minimum_amount: null,
  maximum_discount: null,
  product_id: null,
  campaign_start: null,
  campaign_end: null,
  coupon_valid_from: null,
  coupon_valid_to: null,
  total_coupons: 100,
  initial_coupons: 0,
  status: 'draft',
  is_active: true
})

// è¡¨æ ¼æ¬„ä½å®šç¾©
const columns = [
  { title: 'å°ˆæ¡ˆåç¨±', key: 'name', width: 200, fixed: 'left' },
  { title: 'ç‹€æ…‹', key: 'status', width: 100 },
  { title: 'å„ªæƒ åˆ¸ä¿¡æ¯', key: 'coupon_info', width: 150 },
  { title: 'æ™‚é–“ç¯„åœ', key: 'period', width: 200 },
  { title: 'é€²åº¦çµ±è¨ˆ', key: 'progress', width: 200 },
  { title: 'æ“ä½œ', key: 'actions', width: 250, fixed: 'right' }
]

// è¡¨å–®é©—è­‰è¦å‰‡
const formRules = {
  name: [{ required: true, message: 'è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±' }],
  coupon_prefix: [{ required: true, message: 'è«‹è¼¸å…¥å„ªæƒ ç¢¼å‰ç¶´' }],
  coupon_type: [{ required: true, message: 'è«‹é¸æ“‡å„ªæƒ åˆ¸é¡å‹' }],
  discount_type: [{ required: true, message: 'è«‹é¸æ“‡æŠ˜æ‰£é¡å‹' }],
  discount_value: [{ required: true, message: 'è«‹è¼¸å…¥æŠ˜æ‰£å€¼' }],
  campaign_start: [{ required: true, message: 'è«‹é¸æ“‡å°ˆæ¡ˆé–‹å§‹æ™‚é–“' }],
  campaign_end: [{ required: true, message: 'è«‹é¸æ“‡å°ˆæ¡ˆçµæŸæ™‚é–“' }],
  coupon_valid_from: [{ required: true, message: 'è«‹é¸æ“‡å„ªæƒ åˆ¸æœ‰æ•ˆé–‹å§‹æ™‚é–“' }],
  coupon_valid_to: [{ required: true, message: 'è«‹é¸æ“‡å„ªæƒ åˆ¸æœ‰æ•ˆçµæŸæ™‚é–“' }],
  total_coupons: [{ required: true, message: 'è«‹è¼¸å…¥ç¸½å„ªæƒ åˆ¸æ•¸é‡' }]
}

// ==================== å·¥å…·å‡½æ•¸ ====================

/**
 * ç²å–å°ˆæ¡ˆç‹€æ…‹å°æ‡‰çš„é¡è‰²
 * @param {string} status - å°ˆæ¡ˆç‹€æ…‹
 * @returns {string} Ant Design æ¨™ç±¤é¡è‰²
 */
const getStatusColor = (status) => {
  const colors = {
    draft: 'default',     // è‰ç¨¿ - é è¨­é¡è‰²
    active: 'green',      // é€²è¡Œä¸­ - ç¶ è‰²
    paused: 'orange',     // æš«åœ - æ©™è‰²
    completed: 'blue',    // å·²å®Œæˆ - è—è‰²
    cancelled: 'red'      // å·²å–æ¶ˆ - ç´…è‰²
  }
  return colors[status] || 'default'
}

/**
 * ç²å–å°ˆæ¡ˆç‹€æ…‹çš„ä¸­æ–‡é¡¯ç¤ºæ–‡å­—
 * @param {string} status - å°ˆæ¡ˆç‹€æ…‹è‹±æ–‡å€¼
 * @returns {string} ä¸­æ–‡ç‹€æ…‹æ–‡å­—
 */
const getStatusText = (status) => {
  const texts = {
    draft: 'è‰ç¨¿',
    active: 'é€²è¡Œä¸­',
    paused: 'æš«åœ',
    completed: 'å·²å®Œæˆ',
    cancelled: 'å·²å–æ¶ˆ'
  }
  return texts[status] || status
}

/**
 * ç²å–å°ˆæ¡ˆç‹€æ…‹å°æ‡‰çš„åœ–æ¨™
 * @param {string} status - å°ˆæ¡ˆç‹€æ…‹
 * @returns {string} å°æ‡‰çš„ emoji åœ–æ¨™
 */
const getStatusIcon = (status) => {
  const icons = {
    draft: 'ğŸ“',
    active: 'âš¡',
    paused: 'â¸ï¸',
    completed: 'âœ…',
    cancelled: 'âŒ'
  }
  return icons[status] || 'ğŸ“„'
}

/**
 * ç²å–å„ªæƒ åˆ¸é¡å‹çš„ä¸­æ–‡é¡¯ç¤ºæ–‡å­—
 * @param {string} type - å„ªæƒ åˆ¸é¡å‹è‹±æ–‡å€¼
 * @returns {string} ä¸­æ–‡é¡å‹æ–‡å­—
 */
const getCouponTypeText = (type) => {
  const texts = {
    product_discount: 'å•†å“æŠ˜æ‰£',
    order_discount: 'æ•´ç­†æŠ˜æ‰£',
    free_shipping: 'å…é‹è²»'
  }
  return texts[type] || type
}

/**
 * æ ¼å¼åŒ–æŠ˜æ‰£é¡¯ç¤º
 * @param {string} type - æŠ˜æ‰£é¡å‹ï¼ˆfixed/percentageï¼‰
 * @param {number} value - æŠ˜æ‰£å€¼
 * @returns {string} æ ¼å¼åŒ–çš„æŠ˜æ‰£æ–‡å­—
 */
const formatDiscount = (type, value) => {
  return type === 'percentage' ? `${value}%` : `$${value}`
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤ºï¼ˆç°¡çŸ­æ ¼å¼ï¼‰
 * @param {string} dateStr - æ—¥æœŸå­—ä¸²
 * @returns {string} æ ¼å¼åŒ–çš„æ—¥æœŸï¼ˆMM/DDï¼‰
 */
const formatDate = (dateStr) => {
  return dayjs(dateStr).format('MM/DD')
}

// ==================== API è«‹æ±‚å‡½æ•¸ ====================

/**
 * çµ±ä¸€çš„ API è«‹æ±‚è™•ç†å‡½æ•¸
 * 
 * æä¾›çµ±ä¸€çš„ HTTP è«‹æ±‚è™•ç†ï¼ŒåŒ…æ‹¬ï¼š
 * - è‡ªå‹•æ·»åŠ èªè­‰ header
 * - çµ±ä¸€çš„éŒ¯èª¤è™•ç†
 * - JSON æ ¼å¼è™•ç†
 * 
 * @param {string} url - è«‹æ±‚çš„ URL
 * @param {object} options - fetch é¸é …
 * @returns {Promise<object>} API å›æ‡‰çš„ JSON è³‡æ–™
 * @throws {Error} ç•¶è«‹æ±‚å¤±æ•—æ™‚æ‹‹å‡ºéŒ¯èª¤
 */
const apiRequest = async (url, options = {}) => {
  const response = await fetch(url, {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${authStore.token}`,
      ...options.headers
    },
    ...options
  })
  
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.detail || 'è«‹æ±‚å¤±æ•—')
  }
  
  return response.json()
}

/**
 * è¼‰å…¥è¡ŒéŠ·å°ˆæ¡ˆåˆ—è¡¨
 * 
 * æ ¹æ“šç•¶å‰çš„ç¯©é¸æ¢ä»¶å’Œåˆ†é è¨­å®šå¾ API è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨ï¼ŒåŒ…æ‹¬ï¼š
 * - åˆ†é è™•ç†ï¼ˆskip, limitï¼‰
 * - æœå°‹æ¢ä»¶ï¼ˆå°ˆæ¡ˆåç¨±ï¼‰
 * - ç‹€æ…‹ç¯©é¸ï¼ˆå°ˆæ¡ˆç‹€æ…‹ã€å•Ÿç”¨ç‹€æ…‹ï¼‰
 * - æ›´æ–°åˆ†é çµ±è¨ˆè³‡è¨Š
 */
const loadCampaigns = async () => {
  loading.value = true
  try {
    const params = new URLSearchParams()
    params.append('skip', (pagination.current - 1) * pagination.pageSize)
    params.append('limit', pagination.pageSize)
    
    if (searchText.value) params.append('search', searchText.value)
    if (filterStatus.value) params.append('status', filterStatus.value)
    
    const data = await apiRequest(`/api/campaigns?${params}`)
    
    // å®‰å…¨æª¢æŸ¥APIå›æ‡‰çµæ§‹
    if (data && typeof data === 'object') {
      campaigns.value = data.items || []
      pagination.total = data.total || 0
    } else {
      campaigns.value = []
      pagination.total = 0
      console.warn('APIè¿”å›äº†æ„å¤–çš„è³‡æ–™çµæ§‹:', data)
    }
  } catch (error) {
    console.error('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', error)
    campaigns.value = []
    pagination.total = 0
  } finally {
    loading.value = false
  }
}

/**
 * è¼‰å…¥å°ˆæ¡ˆç¸½è¦½çµ±è¨ˆè³‡æ–™
 * 
 * å¾ API ç²å–è¡ŒéŠ·å°ˆæ¡ˆçš„ç¸½è¦½çµ±è¨ˆè³‡è¨Šï¼ŒåŒ…æ‹¬ï¼š
 * - ç¸½å°ˆæ¡ˆæ•¸é‡
 * - é€²è¡Œä¸­å°ˆæ¡ˆæ•¸é‡  
 * - ç¸½ç”Ÿæˆå„ªæƒ åˆ¸æ•¸é‡
 * - ç¸½ç¯€çœé‡‘é¡ç­‰çµ±è¨ˆæŒ‡æ¨™
 */
const loadStats = async () => {
  statsLoading.value = true
  try {
    const data = await apiRequest('/api/campaigns/stats/overview')
    if (data && typeof data === 'object') {
      stats.value = data
    } else {
      console.warn('çµ±è¨ˆAPIè¿”å›äº†æ„å¤–çš„è³‡æ–™çµæ§‹:', data)
    }
  } catch (error) {
    console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error)
  } finally {
    statsLoading.value = false
  }
}

// äº‹ä»¶è™•ç†
const handleTableChange = (pag) => {
  pagination.current = pag.current
  pagination.pageSize = pag.pageSize
  loadCampaigns()
}

const showCreateModal = () => {
  editingCampaign.value = null
  resetForm()
  createModalVisible.value = true
}

const editCampaign = (campaign) => {
  editingCampaign.value = campaign
  Object.assign(campaignForm, {
    ...campaign,
    campaign_start: dayjs(campaign.campaign_start),
    campaign_end: dayjs(campaign.campaign_end),
    coupon_valid_from: dayjs(campaign.coupon_valid_from),
    coupon_valid_to: dayjs(campaign.coupon_valid_to)
  })
  createModalVisible.value = true
}

const resetForm = () => {
  Object.assign(campaignForm, {
    name: '',
    description: '',
    coupon_prefix: '',
    coupon_type: 'order_discount',
    discount_type: 'fixed',
    discount_value: 0,
    minimum_amount: null,
    maximum_discount: null,
    product_id: null,
    campaign_start: null,
    campaign_end: null,
    coupon_valid_from: null,
    coupon_valid_to: null,
    total_coupons: 100,
    initial_coupons: 0,
    status: 'draft',
    is_active: true
  })
}

const resetFilters = () => {
  searchText.value = ''
  filterStatus.value = null
  loadCampaigns()
}

const handleCreateOrUpdate = async () => {
  try {
    const formData = {
      ...campaignForm,
      campaign_start: campaignForm.campaign_start.toISOString(),
      campaign_end: campaignForm.campaign_end.toISOString(),
      coupon_valid_from: campaignForm.coupon_valid_from.toISOString(),
      coupon_valid_to: campaignForm.coupon_valid_to.toISOString()
    }
    
    if (editingCampaign.value) {
      await apiRequest(`/api/campaigns/${editingCampaign.value.id}`, {
        method: 'PUT',
        body: JSON.stringify(formData)
      })
      message.success('å°ˆæ¡ˆæ›´æ–°æˆåŠŸ')
    } else {
      await apiRequest('/api/campaigns', {
        method: 'POST',
        body: JSON.stringify(formData)
      })
      message.success('å°ˆæ¡ˆå‰µå»ºæˆåŠŸ')
    }
    
    createModalVisible.value = false
    loadCampaigns()
    loadStats()
  } catch (error) {
    message.error(`æ“ä½œå¤±æ•—ï¼š${error.message}`)
  }
}

const updateStatus = async (campaign, status) => {
  try {
    await apiRequest(`/api/campaigns/${campaign.id}/status?status=${status}`, {
      method: 'PATCH'
    })
    message.success('ç‹€æ…‹æ›´æ–°æˆåŠŸ')
    loadCampaigns()
  } catch (error) {
    message.error(`ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š${error.message}`)
  }
}

const deleteCampaign = async (id) => {
  try {
    await apiRequest(`/api/campaigns/${id}`, { method: 'DELETE' })
    message.success('å°ˆæ¡ˆåˆªé™¤æˆåŠŸ')
    loadCampaigns()
    loadStats()
  } catch (error) {
    message.error(`åˆªé™¤å¤±æ•—ï¼š${error.message}`)
  }
}

// å¾…å¯¦ç¾çš„ Modal å‡½æ•¸ï¼ˆç›®å‰ç‚ºä½”ä½å‡½æ•¸ï¼‰
const showStatsModal = (campaign = null) => {
  console.log('é¡¯ç¤ºçµ±è¨ˆ Modal:', campaign)
  message.info('çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...')
}

const showCouponModal = (campaign) => {
  console.log('é¡¯ç¤ºå„ªæƒ åˆ¸ Modal:', campaign)
  message.info('å„ªæƒ åˆ¸ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­...')
}

const showGenerateModal = (campaign) => {
  console.log('é¡¯ç¤ºç”Ÿæˆå„ªæƒ åˆ¸ Modal:', campaign)
  message.info('å„ªæƒ åˆ¸ç”ŸæˆåŠŸèƒ½é–‹ç™¼ä¸­...')
}

const showDistributeModal = (campaign) => {
  console.log('é¡¯ç¤ºåˆ†ç™¼å„ªæƒ åˆ¸ Modal:', campaign)
  message.info('å„ªæƒ åˆ¸åˆ†ç™¼åŠŸèƒ½é–‹ç™¼ä¸­...')
}

// ç”Ÿå‘½é€±æœŸ
onMounted(() => {
  loadCampaigns()
  loadStats()
})
</script>

<style scoped>
.admin-page {
  padding: 24px;
}

.page-header {
  margin-bottom: 24px;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.page-title {
  font-size: 24px;
  font-weight: 600;
  margin: 0 0 8px 0;
  color: #262626;
}

.page-description {
  color: #8c8c8c;
  margin: 0;
  font-size: 14px;
}

.stats-section {
  margin-bottom: 24px;
}

.stats-row {
  margin-bottom: 24px;
}

.filter-section {
  margin-bottom: 24px;
}

.content-section {
  margin-bottom: 24px;
}

.title-cell {
  display: flex;
  flex-direction: column;
}

.campaign-title {
  font-weight: 600;
  color: #262626;
  margin-bottom: 4px;
}

.campaign-prefix {
  color: #8c8c8c;
  font-size: 12px;
}

.coupon-info-cell {
  display: flex;
  flex-direction: column;
  font-size: 14px;
}

.coupon-type {
  font-weight: 500;
  margin-bottom: 2px;
}

.coupon-discount {
  color: #fa8c16;
  font-weight: 600;
}

.period-cell {
  display: flex;
  flex-direction: column;
  font-size: 12px;
}

.period-campaign {
  font-weight: 500;
  margin-bottom: 2px;
}

.period-coupon {
  color: #8c8c8c;
}

.progress-cell {
  display: flex;
  flex-direction: column;
  font-size: 12px;
}

.progress-numbers {
  margin-bottom: 4px;
  font-weight: 500;
}

.progress-stats {
  margin-top: 4px;
  color: #8c8c8c;
}

.form-card {
  margin-bottom: 20px;
}

.campaign-modal {
  width: 1000px;
}

/* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
:deep(.ant-table-tbody > tr > td) {
  vertical-align: top;
  padding: 12px 8px;
}

:deep(.ant-table-thead > tr > th) {
  background: #fafafa;
  font-weight: 600;
}

/* çµ±è¨ˆå¡ç‰‡æ¨£å¼ */
:deep(.stats-section .ant-card) {
  border-radius: 8px;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px 0 rgba(0, 0, 0, 0.02);
}

/* ç¯©é¸å¡ç‰‡æ¨£å¼ */
.filter-card {
  border-radius: 8px;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px 0 rgba(0, 0, 0, 0.02);
}

/* å…§å®¹å¡ç‰‡æ¨£å¼ */
.content-card {
  border-radius: 8px;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px 0 rgba(0, 0, 0, 0.02);
}
</style> 