# BlogCommerce é‡‘æµç³»çµ±ä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®éŒ„

1. [ç³»çµ±æ¦‚è¿°](#ç³»çµ±æ¦‚è¿°)
2. [æ”¯æ´çš„é‡‘æµæ–¹å¼](#æ”¯æ´çš„é‡‘æµæ–¹å¼)
3. [é‡‘æµè¨­å®š](#é‡‘æµè¨­å®š)
4. [ä½¿ç”¨æµç¨‹](#ä½¿ç”¨æµç¨‹)
5. [API æ–‡æª”](#api-æ–‡æª”)
6. [æ¸¬è©¦æŒ‡å—](#æ¸¬è©¦æŒ‡å—)
7. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ğŸ¯ ç³»çµ±æ¦‚è¿°

BlogCommerce é‡‘æµç³»çµ±æ˜¯ä¸€å€‹å®Œæ•´çš„é›»å•†ä»˜æ¬¾è§£æ±ºæ–¹æ¡ˆï¼Œæ”¯æ´å¤šç¨®ä»˜æ¬¾æ–¹å¼ï¼Œæä¾›è‡ªå‹•å’Œæ‰‹å‹•é‡‘æµè™•ç†åŠŸèƒ½ã€‚

### ä¸»è¦ç‰¹è‰²

- âœ… **å¤šå…ƒé‡‘æµæ”¯æ´**ï¼šæ”¯æ´è½‰å¸³ã€Line Payã€ç¶ ç•Œã€PayPal
- âœ… **è‡ªå‹•é‡‘æµè™•ç†**ï¼šè¨‚å–®å»ºç«‹æ™‚è‡ªå‹•ç”¢ç”Ÿä»˜æ¬¾é€£çµ
- âœ… **æ‰‹å‹•é‡‘æµç®¡ç†**ï¼šç®¡ç†å“¡å¯æ‰‹å‹•ç¢ºèªä»˜æ¬¾ç‹€æ…‹
- âœ… **å®Œæ•´ç‹€æ…‹ç®¡ç†**ï¼šè©³ç´°çš„ä»˜æ¬¾ç‹€æ…‹è¿½è¹¤
- âœ… **å®‰å…¨æ€§ä¿éšœ**ï¼šæ”¯æ´æ²™ç›’æ¸¬è©¦ç’°å¢ƒ
- âœ… **ç®¡ç†ä»‹é¢**ï¼šç›´è§€çš„å¾Œå°ç®¡ç†ç³»çµ±

## ğŸ’³ æ”¯æ´çš„é‡‘æµæ–¹å¼

### 1. è½‰å¸³ä»˜æ¬¾ (Transfer)
- **é©ç”¨å ´æ™¯**ï¼šéŠ€è¡Œè½‰å¸³ã€ATM è½‰å¸³
- **è™•ç†æ–¹å¼**ï¼šå®¢æˆ¶è½‰å¸³å¾Œéœ€æ‰‹å‹•ç¢ºèª
- **è¨­å®šé …ç›®**ï¼šéŠ€è¡Œåç¨±ã€å¸³è™Ÿã€æˆ¶å

### 2. Line Pay
- **é©ç”¨å ´æ™¯**ï¼šLine App å…§ä»˜æ¬¾
- **è™•ç†æ–¹å¼**ï¼šå³æ™‚ç·šä¸Šä»˜æ¬¾
- **è¨­å®šé …ç›®**ï¼šChannel IDã€Channel Secretã€å•†åº—åç¨±

### 3. ç¶ ç•Œå…¨æ–¹ä½é‡‘æµ (ECPay)
- **é©ç”¨å ´æ™¯**ï¼šä¿¡ç”¨å¡ã€ATMã€è¶…å•†ä»˜æ¬¾
- **è™•ç†æ–¹å¼**ï¼šå³æ™‚ç·šä¸Šä»˜æ¬¾
- **è¨­å®šé …ç›®**ï¼šMerchant IDã€HashKeyã€HashIVã€API URL

### 4. PayPal
- **é©ç”¨å ´æ™¯**ï¼šåœ‹éš›ä»˜æ¬¾ã€ä¿¡ç”¨å¡ä»˜æ¬¾
- **è™•ç†æ–¹å¼**ï¼šå³æ™‚ç·šä¸Šä»˜æ¬¾
- **è¨­å®šé …ç›®**ï¼šClient IDã€Client Secretã€ç’°å¢ƒè¨­å®š

## âš™ï¸ é‡‘æµè¨­å®š

### å­˜å–ç®¡ç†å¾Œå°

1. ç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ
2. é€²å…¥ `è¨­å®š` â†’ `é‡‘æµè¨­å®š`
3. é¸æ“‡è¦å•Ÿç”¨çš„é‡‘æµæ–¹å¼

### è½‰å¸³è¨­å®š

```json
{
  \"bank\": \"åœ‹æ³°ä¸–è¯éŠ€è¡Œ\",
  \"account\": \"1234567890\",
  \"name\": \"å•†åº—åç¨±\"
}
```

### Line Pay è¨­å®š

```json
{
  \"channel_id\": \"ä½ çš„ Channel ID\",
  \"channel_secret\": \"ä½ çš„ Channel Secret\",
  \"store_name\": \"å•†åº—åç¨±\"
}
```

**å–å¾— Line Pay æ†‘è­‰**ï¼š
1. å‰å¾€ [Line Pay Developer](https://pay.line.me/tw/developers)
2. å»ºç«‹æ‡‰ç”¨ç¨‹å¼
3. å–å¾— Channel ID å’Œ Channel Secret

### ç¶ ç•Œè¨­å®š

```json
{
  \"merchant_id\": \"ä½ çš„ Merchant ID\",
  \"hash_key\": \"ä½ çš„ HashKey\",
  \"hash_iv\": \"ä½ çš„ HashIV\",
  \"api_url\": \"https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5\"
}
```

**å–å¾—ç¶ ç•Œæ†‘è­‰**ï¼š
1. å‰å¾€ [ç¶ ç•Œç§‘æŠ€](https://www.ecpay.com.tw/)
2. ç”³è«‹å•†æˆ¶å¸³è™Ÿ
3. å–å¾—æ¸¬è©¦æˆ–æ­£å¼ç’°å¢ƒæ†‘è­‰

### PayPal è¨­å®š

```json
{
  \"client_id\": \"ä½ çš„ Client ID\",
  \"client_secret\": \"ä½ çš„ Client Secret\",
  \"environment\": \"sandbox\"
}
```

**å–å¾— PayPal æ†‘è­‰**ï¼š
1. å‰å¾€ [PayPal Developer](https://developer.paypal.com/)
2. å»ºç«‹æ‡‰ç”¨ç¨‹å¼
3. å–å¾— Client ID å’Œ Client Secret

## ğŸ”„ ä½¿ç”¨æµç¨‹

### è‡ªå‹•é‡‘æµè™•ç†

1. **å®¢æˆ¶ä¸‹å–®**ï¼šé¸æ“‡å•†å“ä¸¦å¡«å¯«è¨‚å–®è³‡è¨Š
2. **é¸æ“‡ä»˜æ¬¾æ–¹å¼**ï¼šå¾å•Ÿç”¨çš„é‡‘æµæ–¹å¼ä¸­é¸æ“‡
3. **è‡ªå‹•å»ºç«‹ä»˜æ¬¾**ï¼šç³»çµ±è‡ªå‹•ç”¢ç”Ÿä»˜æ¬¾é€£çµæˆ–è³‡è¨Š
4. **å®¢æˆ¶ä»˜æ¬¾**ï¼šæ ¹æ“šä»˜æ¬¾æ–¹å¼å®Œæˆä»˜æ¬¾
5. **ç‹€æ…‹æ›´æ–°**ï¼šä»˜æ¬¾æˆåŠŸå¾Œè‡ªå‹•æ›´æ–°è¨‚å–®ç‹€æ…‹

### æ‰‹å‹•é‡‘æµè™•ç†

1. **ç®¡ç†å“¡æŸ¥çœ‹è¨‚å–®**ï¼šåœ¨ç®¡ç†å¾Œå°æŸ¥çœ‹å¾…ä»˜æ¬¾è¨‚å–®
2. **ç¢ºèªä»˜æ¬¾**ï¼šæ‰‹å‹•ç¢ºèªå®¢æˆ¶å·²å®Œæˆä»˜æ¬¾
3. **æ›´æ–°ç‹€æ…‹**ï¼šå°‡è¨‚å–®ç‹€æ…‹æ›´æ”¹ç‚ºå·²ä»˜æ¬¾
4. **è¨˜éŒ„å‚™è¨»**ï¼šå¯æ·»åŠ ç¢ºèªä»˜æ¬¾çš„å‚™è¨»

### ä»˜æ¬¾ç‹€æ…‹èªªæ˜

- **UNPAID** (æœªä»˜æ¬¾)ï¼šè¨‚å–®å»ºç«‹ï¼Œç­‰å¾…ä»˜æ¬¾
- **PENDING** (ç­‰å¾…ç¢ºèª)ï¼šä»˜æ¬¾è™•ç†ä¸­æˆ–ç­‰å¾…ç¢ºèª
- **PAID** (å·²ä»˜æ¬¾)ï¼šä»˜æ¬¾æˆåŠŸç¢ºèª
- **FAILED** (ä»˜æ¬¾å¤±æ•—)ï¼šä»˜æ¬¾éç¨‹å¤±æ•—
- **REFUNDED** (å·²é€€æ¬¾)ï¼šå·²è™•ç†é€€æ¬¾
- **PARTIAL** (éƒ¨åˆ†ä»˜æ¬¾)ï¼šéƒ¨åˆ†é‡‘é¡å·²ä»˜æ¬¾

## ğŸ“¡ API æ–‡æª”

### é‡‘æµè¨­å®š API

#### å–å¾—é‡‘æµè¨­å®š
```http
GET /api/settings/payment_{method}
Authorization: Bearer {admin_token}
```

#### æ›´æ–°é‡‘æµè¨­å®š
```http
PUT /api/settings/payment_{method}
Authorization: Bearer {admin_token}
Content-Type: application/json

{è¨­å®šè³‡æ–™}
```

### ä»˜æ¬¾è™•ç† API

#### å»ºç«‹ä»˜æ¬¾è¨‚å–®
```http
POST /api/payment/create
Authorization: Bearer {token}
Content-Type: application/json

{
  \"order_id\": \"è¨‚å–®ç·¨è™Ÿ\",
  \"payment_method\": \"ä»˜æ¬¾æ–¹å¼\"
}
```

#### æŸ¥è©¢ä»˜æ¬¾ç‹€æ…‹
```http
GET /api/payment/status/{order_id}
```

#### æ‰‹å‹•ç¢ºèªä»˜æ¬¾
```http
POST /api/payment/manual-confirm
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  \"order_id\": \"è¨‚å–®ç·¨è™Ÿ\",
  \"notes\": \"ç¢ºèªå‚™è¨»\"
}
```

### è¨‚å–®æ•´åˆ

#### å»ºç«‹è¨‚å–®ï¼ˆå«ä»˜æ¬¾æ–¹å¼ï¼‰
```http
POST /api/orders/
Authorization: Bearer {token}
Content-Type: application/json

{
  \"customer_name\": \"å®¢æˆ¶å§“å\",
  \"customer_email\": \"å®¢æˆ¶ä¿¡ç®±\",
  \"customer_phone\": \"å®¢æˆ¶é›»è©±\",
  \"shipping_address\": \"é…é€åœ°å€\",
  \"payment_method\": \"ä»˜æ¬¾æ–¹å¼\",
  \"items\": [
    {
      \"product_id\": 1,
      \"quantity\": 2
    }
  ]
}
```

## ğŸ§ª æ¸¬è©¦æŒ‡å—

### æ¸¬è©¦ç’°å¢ƒè¨­å®š

1. **ä½¿ç”¨æ²™ç›’ç’°å¢ƒ**ï¼šç¢ºä¿æ‰€æœ‰é‡‘æµéƒ½è¨­å®šç‚ºæ¸¬è©¦æ¨¡å¼
2. **æ¸¬è©¦æ†‘è­‰**ï¼šä½¿ç”¨å„é‡‘æµæä¾›çš„æ¸¬è©¦æ†‘è­‰
3. **æ¸¬è©¦è³‡æ–™**ï¼šä½¿ç”¨æ¸¬è©¦ç”¨çš„éŠ€è¡Œå¸³è™Ÿå’Œä¿¡ç”¨å¡è™Ÿ

### åŸ·è¡Œæ¸¬è©¦

#### 1. é‹è¡Œå±•ç¤ºè…³æœ¬
```bash
python3 demo_payment.py
```

#### 2. é‹è¡Œæ¸¬è©¦å¥—ä»¶
```bash
python3 -m pytest tests/test_payment.py -v
```

#### 3. æ¸¬è©¦ç‰¹å®šé‡‘æµ
```bash
# æ¸¬è©¦è½‰å¸³
curl -X GET \"http://localhost:8000/api/payment/test/transfer\" \\
  -H \"Authorization: Bearer {admin_token}\"

# æ¸¬è©¦ Line Pay
curl -X GET \"http://localhost:8000/api/payment/test/linepay\" \\
  -H \"Authorization: Bearer {admin_token}\"
```

### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] é‡‘æµè¨­å®šå¯æ­£å¸¸å„²å­˜å’Œè®€å–
- [ ] è½‰å¸³è¨‚å–®å¯æ­£å¸¸å»ºç«‹
- [ ] Line Pay å¯æ­£å¸¸å»ºç«‹ä»˜æ¬¾é€£çµ
- [ ] ç¶ ç•Œå¯æ­£å¸¸å»ºç«‹ä»˜æ¬¾é€£çµ
- [ ] PayPal å¯æ­£å¸¸å»ºç«‹ä»˜æ¬¾é€£çµ
- [ ] æ‰‹å‹•ç¢ºèªä»˜æ¬¾åŠŸèƒ½æ­£å¸¸
- [ ] ä»˜æ¬¾ç‹€æ…‹æ›´æ–°æ­£å¸¸
- [ ] è¨‚å–®èˆ‡é‡‘æµæ•´åˆæ­£å¸¸

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. Line Pay èªè­‰éŒ¯èª¤
**éŒ¯èª¤**ï¼š`Header information error. authorization is required header.`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- æª¢æŸ¥ Channel ID å’Œ Channel Secret æ˜¯å¦æ­£ç¢º
- ç¢ºèªè«‹æ±‚æ¨™é ­æ ¼å¼æ­£ç¢º
- é©—è­‰æ˜¯å¦ä½¿ç”¨æ­£ç¢ºçš„ API ç«¯é»

#### 2. PayPal èªè­‰å¤±æ•—
**éŒ¯èª¤**ï¼š`Client Authentication failed`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- æª¢æŸ¥ Client ID å’Œ Client Secret æ˜¯å¦æ­£ç¢º
- ç¢ºèªç’°å¢ƒè¨­å®šï¼ˆsandbox/liveï¼‰æ­£ç¢º
- é©—è­‰ PayPal æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹

#### 3. ç¶ ç•Œæª¢æŸ¥ç¢¼éŒ¯èª¤
**éŒ¯èª¤**ï¼š`CheckMacValue verify fail`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- æª¢æŸ¥ HashKey å’Œ HashIV æ˜¯å¦æ­£ç¢º
- ç¢ºèªåƒæ•¸æ’åºå’Œç·¨ç¢¼æ–¹å¼æ­£ç¢º
- é©—è­‰ MAC å€¼è¨ˆç®—é‚è¼¯

#### 4. è³‡æ–™åº«éŒ¯èª¤
**éŒ¯èª¤**ï¼š`table orders has no column named payment_method`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼š`alembic upgrade head`
- æª¢æŸ¥æ¨¡å‹å®šç¾©æ˜¯å¦æ­£ç¢º
- é‡æ–°å»ºç«‹è³‡æ–™åº«è¡¨æ ¼

### åµéŒ¯æŠ€å·§

1. **å•Ÿç”¨è©³ç´°æ—¥èªŒ**ï¼šè¨­å®š `DEBUG=True`
2. **æª¢æŸ¥ API å›æ‡‰**ï¼šä½¿ç”¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·
3. **æ¸¬è©¦ API ç«¯é»**ï¼šä½¿ç”¨ Postman æˆ– curl
4. **æŸ¥çœ‹è³‡æ–™åº«ç‹€æ…‹**ï¼šç›´æ¥æŸ¥è©¢è³‡æ–™åº«ç¢ºèªè³‡æ–™

### è¯çµ¡æ”¯æ´

å¦‚æœé‡åˆ°ç„¡æ³•è§£æ±ºçš„å•é¡Œï¼Œè«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼š

- éŒ¯èª¤è¨Šæ¯å’Œå †ç–Šè¿½è¹¤
- ä½¿ç”¨çš„é‡‘æµæ–¹å¼å’Œè¨­å®š
- æ¸¬è©¦æ­¥é©Ÿå’Œé æœŸçµæœ
- ç³»çµ±ç’°å¢ƒè³‡è¨Š

## ğŸ“ é™„éŒ„

### ç›¸é—œæª”æ¡ˆ

- **æ¨¡å‹å®šç¾©**ï¼š`app/models/order.py`
- **é‡‘æµæœå‹™**ï¼š`app/services/payment_service.py`
- **API è·¯ç”±**ï¼š`app/routes/payment.py`
- **å‰ç«¯è¨­å®š**ï¼š`frontend/src/views/Settings.vue`
- **æ¸¬è©¦æª”æ¡ˆ**ï¼š`tests/test_payment.py`

### å¤–éƒ¨è³‡æº

- [Line Pay API æ–‡æª”](https://pay.line.me/file/guidebook/technicaldocument/LINE_Pay_Integration_Guide_for_Merchant.pdf)
- [ç¶ ç•Œ API æ–‡æª”](https://developers.ecpay.com.tw/)
- [PayPal API æ–‡æª”](https://developer.paypal.com/docs/api/)

---

**ç‰ˆæœ¬**ï¼š1.0.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2025-06-25  
**ç¶­è­·è€…**ï¼šBlogCommerce é–‹ç™¼åœ˜éšŠ