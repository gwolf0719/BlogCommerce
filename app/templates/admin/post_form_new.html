<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if post_id %}編輯文章{% else %}新增文章{% endif %} - 後台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
</head>
<body class="bg-gray-50" x-data="postFormApp()" x-init="init()">
    <!-- 頂部導航 -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/admin" class="text-xl font-bold text-gray-900">
                        後台管理
                    </a>
                    <span class="mx-3 text-gray-400">/</span>
                    <a href="/admin/posts" class="text-gray-600 hover:text-gray-900">文章管理</a>
                    <span class="mx-3 text-gray-400">/</span>
                    <span class="text-gray-900">{% if post_id %}編輯文章{% else %}新增文章{% endif %}</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500">管理員</span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800 text-sm">
                        登出
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主內容 -->
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <form @submit.prevent="savePost()" class="space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 左側主要內容 -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- 標題 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    文章標題 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" 
                                       x-model="form.title" 
                                       @input="generateSlug()"
                                       placeholder="輸入文章標題..."
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    網址別名 (slug)
                                </label>
                                <input type="text" 
                                       x-model="form.slug" 
                                       placeholder="文章的網址別名..."
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <p class="text-xs text-gray-500 mt-1">留空將自動生成</p>
                            </div>
                        </div>
                    </div>

                    <!-- 內容摘要 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">內容摘要</h3>
                        <textarea x-model="form.excerpt" 
                                  rows="4" 
                                  placeholder="輸入文章摘要..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </textarea>
                    </div>

                    <!-- 文章內容 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">文章內容</h3>
                        <div class="space-y-4">
                            <textarea id="editor" 
                                      x-model="form.content"
                                      rows="15" 
                                      placeholder="開始撰寫您的文章..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </textarea>
                        </div>
                    </div>

                    <!-- SEO 設定 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">SEO 設定</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    SEO 標題
                                </label>
                                <input type="text" 
                                       x-model="form.meta_title" 
                                       placeholder="SEO 標題（留空使用文章標題）"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    SEO 描述
                                </label>
                                <textarea x-model="form.meta_description" 
                                          rows="3" 
                                          placeholder="SEO 描述（留空使用摘要）"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側設定面板 -->
                <div class="space-y-6">
                    <!-- 發布設定 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">發布設定</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    狀態
                                </label>
                                <select x-model="form.status" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="draft">草稿</option>
                                    <option value="published">已發布</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    發布時間
                                </label>
                                <input type="datetime-local" 
                                       x-model="form.published_at"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           x-model="form.is_featured"
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">精選文章</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- AI 生成功能 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                            <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            AI 文章生成
                        </h3>
                        
                        <div x-show="!aiEnabled" class="text-center py-8">
                            <div class="text-gray-400 mb-2">
                                <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-500 mb-4">AI 功能未啟用</p>
                            <a href="/admin/settings" class="text-purple-600 hover:text-purple-700 text-sm">
                                前往系統設定啟用 →
                            </a>
                        </div>

                        <div x-show="aiEnabled">
                            <div x-show="!showAiForm">
                                <button @click="showAiForm = true" 
                                        type="button"
                                        class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    使用 AI 生成文章
                                </button>
                            </div>

                            <div x-show="showAiForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        文章提示詞 <span class="text-red-500">*</span>
                                    </label>
                                    <textarea x-model="aiPrompt" 
                                              rows="4" 
                                              placeholder="請描述您想要生成的文章內容，例如：寫一篇關於AI在教育領域應用的文章，包含現狀分析、未來趨勢和實際案例..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                                    </textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        標題提示（可選）
                                    </label>
                                    <input type="text" 
                                           x-model="titleHint" 
                                           placeholder="給AI一個標題方向，例如：創新教學"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                                </div>

                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" 
                                               x-model="generateImage" 
                                               class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                        <span class="ml-2 text-sm text-gray-700">同時生成特色圖片</span>
                                    </label>
                                </div>

                                <div class="flex space-x-3">
                                    <button @click="generateAiContent()" 
                                            type="button"
                                            :disabled="generating || !aiPrompt.trim()"
                                            class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center">
                                        <span x-show="!generating">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                            生成文章
                                        </span>
                                        <span x-show="generating">
                                            <svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            生成中...
                                        </span>
                                    </button>
                                    <button @click="showAiForm = false; aiPrompt = ''; titleHint = ''" 
                                            type="button"
                                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                                        取消
                                    </button>
                                </div>

                                <div x-show="aiError" class="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-red-800" x-text="aiError"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 特色圖片 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">特色圖片</h3>
                        <div class="space-y-4">
                            <div x-show="form.featured_image" class="text-center">
                                <img :src="form.featured_image" 
                                     alt="特色圖片預覽" 
                                     class="w-full h-40 object-cover rounded-lg mb-2">
                                <button type="button" 
                                        @click="form.featured_image = ''" 
                                        class="text-red-600 hover:text-red-800 text-sm">
                                    移除圖片
                                </button>
                            </div>
                            <div x-show="!form.featured_image">
                                <input type="url" 
                                       x-model="form.featured_image" 
                                       placeholder="輸入圖片網址..."
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-2">
                                <p class="text-xs text-gray-500">
                                    建議尺寸：1200x630 像素
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 分類 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">分類</h3>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            <template x-for="category in categories" :key="category.id">
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           :value="category.id"
                                           x-model="form.category_ids"
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700" x-text="category.name"></span>
                                </label>
                            </template>
                        </div>
                    </div>

                    <!-- 標籤 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">標籤</h3>
                        <div class="space-y-2">
                            <input type="text" 
                                   x-model="newTag" 
                                   @keydown.enter.prevent="addTag()"
                                   placeholder="輸入標籤名稱後按 Enter..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <div class="flex flex-wrap gap-2">
                                <template x-for="(tag, index) in form.tags" :key="index">
                                    <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">
                                        <span x-text="tag"></span>
                                        <button type="button" 
                                                @click="removeTag(index)" 
                                                class="ml-1 text-gray-500 hover:text-gray-700">
                                            <i class="fas fa-times text-xs"></i>
                                        </button>
                                    </span>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按鈕 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <div class="space-y-3">
                            <button type="submit" 
                                    :disabled="saving"
                                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50">
                                <span x-show="!saving">
                                    {% if post_id %}更新文章{% else %}發布文章{% endif %}
                                </span>
                                <span x-show="saving">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>儲存中...
                                </span>
                            </button>
                            <button type="button" 
                                    @click="saveDraft()"
                                    :disabled="saving"
                                    class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50">
                                儲存草稿
                            </button>
                            {% if post_id %}
                            <a :href="'/blog/' + form.slug" 
                               target="_blank"
                               class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 text-center block">
                                預覽文章
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
    function postFormApp() {
        return {
            form: {
                title: '',
                slug: '',
                excerpt: '',
                content: '',
                status: 'draft',
                published_at: '',
                is_featured: false,
                featured_image: '',
                meta_title: '',
                meta_description: '',
                category_ids: [],
                tags: []
            },
            categories: [],
            newTag: '',
            saving: false,
            saveStatus: null,
            postId: {% if post_id %}{{ post_id }}{% else %}null{% endif %},
            
            // AI 功能相關
            aiEnabled: false,
            showAiForm: false,
            aiPrompt: '',
            titleHint: '',
            generateImage: true,
            generating: false,
            aiError: null,

            async init() {
                await this.loadCategories();
                if (this.postId) {
                    await this.loadPost();
                }
                await this.checkAiStatus();
                this.initEditor();
            },

            initEditor() {
                ClassicEditor
                    .create(document.querySelector('#editor'))
                    .then(editor => {
                        window.editor = editor;
                        editor.model.document.on('change:data', () => {
                            this.form.content = editor.getData();
                        });
                    })
                    .catch(error => {
                        console.error(error);
                    });
            },

            // AI 功能相關方法
            async checkAiStatus() {
                try {
                    const token = localStorage.getItem('access_token');
                    const response = await fetch('/api/admin/ai/status', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        const status = await response.json();
                        this.aiEnabled = status.ai_enabled;
                    }
                } catch (error) {
                    console.error('檢查AI狀態失敗:', error);
                    this.aiEnabled = false;
                }
            },

            async generateAiContent() {
                if (!this.aiPrompt.trim()) {
                    this.aiError = '請輸入文章提示詞';
                    return;
                }

                this.generating = true;
                this.aiError = null;

                try {
                    const token = localStorage.getItem('access_token');
                    const response = await fetch('/api/admin/posts/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            prompt: this.aiPrompt,
                            title_hint: this.titleHint,
                            generate_image: this.generateImage
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            const data = result.data;
                            
                            // 填充生成的內容到表單
                            this.form.title = data.title || '';
                            this.form.excerpt = data.excerpt || '';
                            this.form.content = data.content || '';
                            this.form.meta_title = data.title || '';
                            this.form.meta_description = data.meta_description || data.excerpt || '';
                            
                            // 更新編輯器內容
                            if (window.editor) {
                                window.editor.setData(data.content || '');
                            }
                            
                            // 如果生成了圖片，設置特色圖片
                            if (data.featured_image) {
                                this.form.featured_image = data.featured_image;
                            }
                            
                            // 設置標籤
                            if (data.tags && Array.isArray(data.tags)) {
                                this.form.tags = data.tags;
                            }
                            
                            // 自動生成slug
                            this.generateSlug();
                            
                            // 關閉AI表單
                            this.showAiForm = false;
                            this.aiPrompt = '';
                            this.titleHint = '';
                            
                            this.showToast('AI文章生成成功！請檢查內容後發布', 'success');
                        } else {
                            this.aiError = result.error || 'AI生成失敗';
                        }
                    } else {
                        const errorData = await response.json();
                        this.aiError = errorData.detail || 'AI生成請求失敗';
                    }
                } catch (error) {
                    console.error('AI生成失敗:', error);
                    this.aiError = '網路錯誤，請稍後再試';
                } finally {
                    this.generating = false;
                }
            },

            async loadCategories() {
                try {
                    const response = await fetch('/api/categories/?type=blog');
                    if (response.ok) {
                        this.categories = await response.json();
                    }
                } catch (error) {
                    console.error('載入分類失敗:', error);
                }
            },

            async loadPost() {
                try {
                    const response = await fetch(`/api/posts/${this.postId}`);
                    if (response.ok) {
                        const post = await response.json();
                        this.form = {
                            title: post.title || '',
                            slug: post.slug || '',
                            excerpt: post.excerpt || '',
                            content: post.content || '',
                            status: post.status || 'draft',
                            published_at: post.published_at ? new Date(post.published_at).toISOString().slice(0, 16) : '',
                            is_featured: post.is_featured || false,
                            featured_image: post.featured_image || '',
                            meta_title: post.meta_title || '',
                            meta_description: post.meta_description || '',
                            category_ids: post.categories?.map(c => c.id) || [],
                            tags: post.tags?.map(t => t.name) || []
                        };
                    }
                } catch (error) {
                    console.error('載入文章失敗:', error);
                    this.showToast('載入文章失敗', 'error');
                }
            },

            generateSlug() {
                if (this.form.title && !this.postId) {
                    this.form.slug = this.form.title
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .trim();
                }
            },

            addTag() {
                if (this.newTag.trim() && !this.form.tags.includes(this.newTag.trim())) {
                    this.form.tags.push(this.newTag.trim());
                    this.newTag = '';
                }
            },

            removeTag(index) {
                this.form.tags.splice(index, 1);
            },

            async savePost() {
                this.saving = true;
                this.saveStatus = 'saving';

                try {
                    const token = localStorage.getItem('access_token');
                    const method = this.postId ? 'PUT' : 'POST';
                    const url = this.postId ? `/api/posts/${this.postId}` : '/api/posts/';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(this.form)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.saveStatus = 'saved';
                        this.showToast('文章已儲存', 'success');
                        
                        if (!this.postId) {
                            // 新增文章後重定向到編輯頁面
                            setTimeout(() => {
                                window.location.href = `/admin/posts/${result.id}/edit`;
                            }, 1000);
                        }
                    } else {
                        this.saveStatus = 'error';
                        this.showToast('儲存失敗', 'error');
                    }
                } catch (error) {
                    console.error('儲存文章失敗:', error);
                    this.saveStatus = 'error';
                    this.showToast('儲存失敗', 'error');
                } finally {
                    this.saving = false;
                    setTimeout(() => {
                        this.saveStatus = null;
                    }, 3000);
                }
            },

            async saveDraft() {
                const originalStatus = this.form.status;
                this.form.status = 'draft';
                await this.savePost();
                this.form.status = originalStatus;
            },

            showToast(message, type) {
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
                    type === 'success' ? 'bg-green-500' : 'bg-red-500'
                }`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        }
    }

    function logout() {
        localStorage.removeItem('access_token');
        window.location.href = '/admin/login';
    }
    </script>
</body>
</html> 